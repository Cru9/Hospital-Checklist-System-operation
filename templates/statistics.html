{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-6 mb-5">
        <div class="flex justify-between items-center border-b pb-3 mb-4 border-gray-200">
            <h1 class="text-2xl font-medium text-gray-800">Estadísticas de Reportes Hospitalarios</h1>
            <a href="{{ url_for('dashboard') }}" class="bg-secondary-green hover:bg-dark-green text-white font-medium py-2 px-4 rounded-md transition duration-300">Volver al Dashboard</a>
        </div>

        <form method="POST" class="mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="start_date" class="block text-gray-700 font-medium mb-2">Fecha de Inicio:</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="end_date" class="block text-gray-700 font-medium mb-2">Fecha de Fin:</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button type="submit" class="w-full md:w-auto py-2 px-4 bg-primary-red hover:bg-red-700 text-white font-medium rounded-md transition duration-300">Aplicar Filtro</button>
            </div>
        </form>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-medium text-gray-800 mb-4">Total de Operaciones por Día</h2>
                <canvas id="operationsChart"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-medium text-gray-800 mb-4">Porcentaje Promedio de Cumplimiento de Unidad por Día</h2>
                <canvas id="unitCompletionChart"></canvas>
            </div>
            </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="border-b pb-3 mb-4 border-gray-200">
                <h2 class="text-xl font-medium text-gray-800">Análisis Detallado del Checklist</h2>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Item del Checklist</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Porcentaje de Cumplimiento</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Veces Marcado (Sí)</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Total de Reportes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item_data in detailed_checklist_percentages %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200">{{ item_data.item }}</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                <span class="inline-block px-3 py-1 rounded-full text-white font-semibold
                                    {% if item_data.percentage >= 80 %} bg-success
                                    {% elif item_data.percentage >= 50 %} bg-warning
                                    {% else %} bg-danger
                                    {% endif %}"
                                    title="Veces Marcado (Sí): {{ item_data.checked_count }}\nTotal de Reportes: {{ item_data.total_count }}">
                                    {{ item_data.percentage }}%
                                </span>
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ item_data.checked_count }}</td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ item_data.total_count }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="py-3 px-4 text-center text-gray-500 border-b border-gray-200">No hay datos de checklist disponibles para el rango de fechas seleccionado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="border-b pb-3 mb-4 border-gray-200">
                <h2 class="text-xl font-medium text-gray-800">Resumen Ejecutivo de Reportes por Fecha y Hospital</h2>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Fecha</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Hospital</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Meta Cumplida</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Operaciones</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">% Unidad</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.date }}</td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.hospital_name }}</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                {% if report.met_goal == True %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-success">Sí</span>
                                {% elif report.met_goal == False %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-danger">No</span>
                                {% else %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-neutral-gray/20 text-neutral-gray">N/A</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                {% if report.met_goal == True %}
                                    7
                                {% elif report.operations_performed is not none %}
                                    {{ report.operations_performed }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                <span class="inline-block px-2 py-1 text-xs font-medium rounded-full
                                    {% if report.unit_percentage >= 80 %} bg-green-100 text-success
                                    {% elif report.unit_percentage >= 50 %} bg-yellow-100 text-warning
                                    {% else %} bg-red-100 text-danger
                                    {% endif %}">
                                    {{ report.unit_percentage }}%
                                </span>
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.observations if report.observations else 'Sin observaciones' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="py-3 px-4 text-center text-gray-500 border-b border-gray-200">No hay reportes para el rango de fechas seleccionado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Data for Operations Chart
        const operationsChartData = JSON.parse('{{ chart_data_operations | safe }}');
        const operationsCtx = document.getElementById('operationsChart').getContext('2d');
        new Chart(operationsCtx, {
            type: 'bar',
            data: {
                labels: operationsChartData.labels,
                datasets: [{
                    label: 'Total de Operaciones',
                    data: operationsChartData.data,
                    backgroundColor: 'rgba(35, 92, 79, 0.7)', // secondary-green
                    borderColor: 'rgba(35, 92, 79, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Total de Operaciones Reportadas por Día'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Número de Operaciones'
                        },
                        ticks: {
                            precision: 0 // Ensure integer ticks for operation count
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    }
                }
            }
        });

        // Data for Unit Completion Chart
        const unitCompletionChartData = JSON.parse('{{ chart_data_unit_completion | safe }}');
        const unitCompletionCtx = document.getElementById('unitCompletionChart').getContext('2d');
        new Chart(unitCompletionCtx, {
            type: 'line',
            data: {
                labels: unitCompletionChartData.labels,
                datasets: [{
                    label: 'Porcentaje Promedio de Unidad',
                    data: unitCompletionChartData.data,
                    backgroundColor: 'rgba(140, 16, 51, 0.7)', // primary-red
                    borderColor: 'rgba(140, 16, 51, 1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Porcentaje Promedio de Cumplimiento de Unidad por Día'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Porcentaje (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    }
                }
            }
        });

        // Removed: Historical Goals Chart (Total de Veces Meta Cumplida por Hospital)
    });
</script>
{% endblock %}