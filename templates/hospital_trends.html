{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md p-6 mb-5">
        <div class="flex justify-between items-center border-b pb-3 mb-4 border-gray-200">
            <h1 class="text-2xl font-medium text-gray-800">Análisis de Tendencias por Hospital</h1>
            <a href="{{ url_for('dashboard') }}" class="bg-gray-500 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">Volver al Dashboard</a>
        </div>

        <form method="POST" action="{{ url_for('hospital_trends') }}" class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4">
            <div>
                <label for="hospital_id" class="block text-gray-700 text-sm font-bold mb-2">Seleccionar Hospital:</label>
                <select name="hospital_id" id="hospital_id" class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                    <option value="">-- Seleccione un Hospital --</option>
                    {% for id, name in hospital_names.items() %}
                        <option value="{{ id }}" {% if id == selected_hospital_id %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="start_date" class="block text-gray-700 text-sm font-bold mb-2">Fecha de Inicio:</label>
                <input type="date" name="start_date" id="start_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ start_date }}">
            </div>
            <div>
                <label for="end_date" class="block text-gray-700 text-sm font-bold mb-2">Fecha de Fin:</label>
                <input type="date" name="end_date" id="end_date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ end_date }}">
            </div>
            <button type="submit" class="bg-secondary-green hover:bg-dark-green text-white font-medium py-2 px-4 rounded-md transition duration-300">Mostrar Tendencias</button>
        </form>

        {% if selected_hospital_id %}
        <h2 class="text-xl font-medium text-gray-800 mb-4">{{ selected_hospital_name }} - Tendencias</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Porcentaje de Cumplimiento del Checklist</h3>
                <canvas id="unitPercentageChart"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Cumplimiento de Meta de Operaciones (1=Sí, 0=No)</h3>
                <canvas id="metGoalChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-4">Problemas Recurrentes (Frecuencia en el Período)</h3>
            {% if recurring_problems %}
            <ul class="list-disc pl-5 text-gray-700">
                {% for item, count in recurring_problems %}
                <li>{{ item }}: {{ count }} veces</li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No se encontraron problemas recurrentes o reportes en el período seleccionado para este hospital.</p>
            {% endif %}
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-medium text-gray-700 mb-4">Detalle de Reportes ({{ start_date }} a {{ end_date }})</h3>
            {% if hospital_reports_data %}
            <div class="overflow-x-auto no-scrollbar">
                <table class="w-full border-collapse">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Fecha</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Meta Cumplida</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Operaciones Realizadas</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">% Unidad</th>
                            <th class="py-3 px-4 text-left bg-gray-100 font-medium text-gray-700 border-b border-gray-200">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in hospital_reports_data %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.date }}</td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                {% if report.met_goal == True %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-success">Sí</span>
                                {% elif report.met_goal == False %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-danger">No</span>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">
                                {% if report.met_goal == True %}
                                    7
                                {% elif report.operations_performed is not none %}
                                    {{ report.operations_performed }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.unit_percentage | round(1) }}%</td>
                            <td class="py-3 px-4 border-b border-gray-200">{{ report.observations if report.observations else 'Sin observaciones' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>No hay datos de reportes para este hospital en el rango de fechas seleccionado.</p>
            {% endif %}
        </div>

        {% else %}
        <p class="text-gray-600">Por favor, seleccione un hospital y un rango de fechas para ver las tendencias.</p>
        {% endif %}

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Only attempt to render charts if data is present (i.e., a hospital has been selected)
        if ({{ selected_hospital_id | tojson }} && {{ unit_percentage_chart_data | tojson }} && {{ met_goal_chart_data | tojson }}) {
            const unitPercentageData = JSON.parse({{ unit_percentage_chart_data | tojson }});
            const metGoalData = JSON.parse({{ met_goal_chart_data | tojson }});

            // Unit Percentage Chart
            const unitPercentageCtx = document.getElementById('unitPercentageChart').getContext('2d');
            new Chart(unitPercentageCtx, {
                type: 'line',
                data: {
                    labels: unitPercentageData.labels,
                    datasets: [{
                        label: 'Porcentaje de Cumplimiento de la Unidad (%)',
                        data: unitPercentageData.data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Porcentaje (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Met Goal Chart
            const metGoalCtx = document.getElementById('metGoalChart').getContext('2d');
            new Chart(metGoalCtx, {
                type: 'line',
                data: {
                    labels: metGoalData.labels,
                    datasets: [{
                        label: 'Meta de Operaciones Cumplida (1=Sí, 0=No)',
                        data: metGoalData.data,
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1.1, // Slightly above 1 for better visualization of 0/1
                            ticks: {
                                callback: function(value, index, values) {
                                    if (value === 1) return 'Sí';
                                    if (value === 0) return 'No';
                                    return ''; // Hide other tick labels
                                }
                            },
                            title: {
                                display: true,
                                text: 'Meta Cumplida'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    return context.dataset.label + ': ' + (value === 1 ? 'Sí' : 'No');
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}